<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ocorrências</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .level-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .level-1 { background-color: #e6f7ff; color: #004085; }
        .level-2 { background-color: #fff3cd; color: #856404; }
        .level-3 { background-color: #ffeeba; color: #856404; }
        .level-4 { background-color: #f8d7da; color: #721c24; }
        .level-5 { background-color: #dc3545; color: white; }
        .occurrence-table {
            font-size: 0.9rem;
        }
        .occurrence-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .export-btn {
            margin-left: 10px;
        }
        .cause-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .cause-structural { background-color: #d1e7ff; color: #0a58ca; }
        .cause-behavioral { background-color: #fff3bf; color: #8a6d3b; }
        .effect-badge { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-exclamation-triangle"></i> Dashboard de Ocorrências</h1>
                    <p class="mb-0">Análise detalhada das ocorrências registradas</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="exportData" class="btn btn-light">
                        <i class="fas fa-download"></i> Exportar Dados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label for="locationFilter" class="form-label">Unidade</label>
                    <select id="locationFilter" class="form-select">
                        <option value="all">Todas as unidades</option>
                        <option value="Fabrica Suzano Belem">Fábrica Suzano Belém</option>
                        <option value="Fabrica Suzano Limeira">Fábrica Suzano Limeira</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateRange" class="form-label">Período</label>
                    <input type="text" class="form-control" id="dateRange" placeholder="Selecione o período">
                </div>
                <div class="col-md-2">
                    <label for="levelFilter" class="form-label">Nível</label>
                    <select id="levelFilter" class="form-select">
                        <option value="all">Todos</option>
                        <option value="1">Nível 1</option>
                        <option value="2">Nível 2</option>
                        <option value="3">Nível 3</option>
                        <option value="4">Nível 4</option>
                        <option value="5">Nível 5</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="causeFilter" class="form-label">Causa</label>
                    <select id="causeFilter" class="form-select">
                        <option value="all">Todas</option>
                        <option value="Estrutural">Estrutural</option>
                        <option value="Comportamental">Comportamental</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="effectFilter" class="form-label">Efeito</label>
                    <select id="effectFilter" class="form-select">
                        <option value="all">Todos</option>
                        <option value="Batida de empilhadeira contra estruturas">Batida empilhadeira</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="typeFilter" class="form-label">Tipo de Ocorrência</label>
                    <select id="typeFilter" class="form-select">
                        <option value="all">Todos os tipos</option>
                        <option value="Ocorrência com vítimas">Com vítimas</option>
                        <option value="Ocorrência com danos estruturais">Com danos</option>
                        <option value="Descumprimento das Regras de Ouro">Regras violadas</option>
                    </select>
                </div>
                <div class="col-md-8 d-flex align-items-end">
                    <button id="applyFilters" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                    <button id="resetFilters" class="btn btn-outline-secondary export-btn">
                        <i class="fas fa-undo"></i> Limpar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="row">
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-value" id="totalOccurrences">0</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-value" id="avgLevel">0</div>
                    <div class="stat-label">Nível Médio</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-value" id="victimOccurrences">0</div>
                    <div class="stat-label">Com Vítimas</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-value" id="structureOccurrences">0</div>
                    <div class="stat-label">Com Danos</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-value" id="structuralCause">0</div>
                    <div class="stat-label">Causa Estrutural</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card">
                    <div class="stat-value" id="behavioralCause">0</div>
                    <div class="stat-label">Causa Comportamental</div>
                </div>
            </div>
        </div>

        <!-- Gráficos e Tabelas -->
        <div class="row mt-4">
            <!-- Gráfico 1: Ocorrências por Dia -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Ocorrências por Dia
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dailyOccurrencesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico 2: Distribuição por Nível -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Distribuição por Nível
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="levelDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Gráfico 3: Causas Raiz -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Causas Raiz das Ocorrências
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rootCauseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico 4: Efeitos Gerados -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Efeitos Gerados
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="effectChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Gráfico 5: Tipos de Causa Estrutural -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Tipos de Causa Estrutural
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="structuralCauseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico 6: Tipos de Causa Comportamental -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Tipos de Causa Comportamental
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="behavioralCauseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Ocorrências -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Detalhes das Ocorrências
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover occurrence-table">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Local</th>
                                        <th>Tipo</th>
                                        <th>Nível</th>
                                        <th>Causa Raiz</th>
                                        <th>Efeito</th>
                                        <th>Responsável</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="occurrencesTableBody">
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalhes da Ocorrência -->
    <div class="modal fade" id="occurrenceDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Ocorrência</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="occurrenceDetailContent">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase e Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="js.js"></script>
    <script>
        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Variáveis globais
        let allOccurrences = [];
        let filteredOccurrences = [];
        let charts = {};

        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Configura o date range picker
            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: "pt",
                defaultDate: [new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), new Date()]
            });

            // Carrega os dados do Firebase
            loadOccurrencesData();

            // Configura os eventos dos botões
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('exportData').addEventListener('click', exportData);
        });

        // Carrega os dados das ocorrências do Firebase
        function loadOccurrencesData() {
            const occurrencesRef = database.ref('occurrences');
            
            occurrencesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                allOccurrences = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        const occurrence = data[key];
                        occurrence.id = key;
                        allOccurrences.push(occurrence);
                    });
                }
                
                // Ordena por data (mais recente primeiro)
                allOccurrences.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Aplica os filtros padrão
                applyFilters();
            });
        }

        // Aplica os filtros selecionados
        function applyFilters() {
            const locationFilter = document.getElementById('locationFilter').value;
            const dateRange = document.getElementById('dateRange')._flatpickr.selectedDates;
            const levelFilter = document.getElementById('levelFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const causeFilter = document.getElementById('causeFilter').value;
            const effectFilter = document.getElementById('effectFilter').value;
            
            filteredOccurrences = allOccurrences.filter(occurrence => {
                // Filtro por local
                if (locationFilter !== 'all' && occurrence.location !== locationFilter) {
                    return false;
                }
                
                // Filtro por data
                if (dateRange.length === 2) {
                    const occurrenceDate = new Date(occurrence.date);
                    const startDate = new Date(dateRange[0]);
                    const endDate = new Date(dateRange[1]);
                    
                    // Ajusta a data final para incluir todo o dia
                    endDate.setHours(23, 59, 59, 999);
                    
                    if (occurrenceDate < startDate || occurrenceDate > endDate) {
                        return false;
                    }
                }
                
                // Filtro por nível
                if (levelFilter !== 'all' && occurrence.level != levelFilter) {
                    return false;
                }
                
                // Filtro por tipo
                if (typeFilter !== 'all' && !occurrence.occurrenceType.includes(typeFilter)) {
                    return false;
                }
                
                // Filtro por causa raiz
                if (causeFilter !== 'all') {
                    if (causeFilter === 'Estrutural' && (!occurrence.answers || !occurrence.answers.rootCause || occurrence.answers.rootCause !== 'Estrutural')) {
                        return false;
                    }
                    if (causeFilter === 'Comportamental' && (!occurrence.answers || !occurrence.answers.rootCause || occurrence.answers.rootCause !== 'Comportamental')) {
                        return false;
                    }
                    if (causeFilter === 'Outro' && (!occurrence.answers || !occurrence.answers.rootCause || occurrence.answers.rootCause !== 'Outro')) {
                        return false;
                    }
                }
                
                // Filtro por efeito gerado
                if (effectFilter !== 'all' && (!occurrence.answers || !occurrence.answers.main_effect || occurrence.answers.main_effect !== effectFilter)) {
                    return false;
                }
                
                return true;
            });
            
            // Atualiza as estatísticas e gráficos
            updateStatistics();
            updateCharts();
            updateTable();
        }

        // Reseta todos os filtros
        function resetFilters() {
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('causeFilter').value = 'all';
            document.getElementById('effectFilter').value = 'all';
            document.getElementById('dateRange')._flatpickr.clear();
            
            applyFilters();
        }

        // Atualiza as estatísticas
        function updateStatistics() {
            const total = filteredOccurrences.length;
            document.getElementById('totalOccurrences').textContent = total;
            
            // Calcula o nível médio
            const avgLevel = total > 0 
                ? (filteredOccurrences.reduce((sum, o) => sum + parseInt(o.level), 0) / total).toFixed(1)
                : 0;
            document.getElementById('avgLevel').textContent = avgLevel;
            
            // Conta ocorrências com vítimas
            const withVictims = filteredOccurrences.filter(o => 
                o.answers && o.answers.q1 === 'Sim').length;
            document.getElementById('victimOccurrences').textContent = withVictims;
            
            // Conta ocorrências com danos estruturais
            const withDamage = filteredOccurrences.filter(o => 
                o.answers && o.answers.q2 === 'Sim').length;
            document.getElementById('structureOccurrences').textContent = withDamage;
            
            // Conta ocorrências com causa estrutural
            const structuralCause = filteredOccurrences.filter(o => 
                o.answers && o.answers.rootCause === 'Estrutural').length;
            document.getElementById('structuralCause').textContent = structuralCause;
            
            // Conta ocorrências com causa comportamental
            const behavioralCause = filteredOccurrences.filter(o => 
                o.answers && o.answers.rootCause === 'Comportamental').length;
            document.getElementById('behavioralCause').textContent = behavioralCause;
        }

        // Atualiza os gráficos
        function updateCharts() {
            updateDailyOccurrencesChart();
            updateLevelDistributionChart();
            updateRootCauseChart();
            updateEffectChart();
            updateStructuralCauseChart();
            updateBehavioralCauseChart();
        }

        // Gráfico de Ocorrências por Dia
        function updateDailyOccurrencesChart() {
            const dateRange = document.getElementById('dateRange')._flatpickr.selectedDates;
            let days = [];
            let counts = [];
            
            if (dateRange.length === 2) {
                const startDate = new Date(dateRange[0]);
                const endDate = new Date(dateRange[1]);
                
                // Cria um array com todos os dias no intervalo
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    days.push(dateStr);
                    counts.push(0);
                }
                
                // Conta as ocorrências por dia
                filteredOccurrences.forEach(o => {
                    const occurrenceDate = new Date(o.date);
                    const dateStr = occurrenceDate.toISOString().split('T')[0];
                    const index = days.indexOf(dateStr);
                    
                    if (index !== -1) {
                        counts[index]++;
                    }
                });
            } else {
                // Se não houver intervalo definido, agrupa por dia para todas as ocorrências
                const dailyCounts = {};
                
                filteredOccurrences.forEach(o => {
                    const occurrenceDate = new Date(o.date);
                    const dateStr = occurrenceDate.toISOString().split('T')[0];
                    
                    if (!dailyCounts[dateStr]) {
                        dailyCounts[dateStr] = 0;
                    }
                    dailyCounts[dateStr]++;
                });
                
                days = Object.keys(dailyCounts).sort();
                counts = days.map(date => dailyCounts[date]);
            }
            
            // Formata as datas para exibição
            const formattedDays = days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('pt-BR');
            });
            
            const ctx = document.getElementById('dailyOccurrencesChart').getContext('2d');
            
            if (charts.dailyOccurrences) {
                charts.dailyOccurrences.data.labels = formattedDays;
                charts.dailyOccurrences.data.datasets[0].data = counts;
                charts.dailyOccurrences.update();
            } else {
                charts.dailyOccurrences = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: formattedDays,
                        datasets: [{
                            label: 'Ocorrências por Dia',
                            data: counts,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Ocorrências'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Distribuição por Nível
        function updateLevelDistributionChart() {
            const levels = [1, 2, 3, 4, 5];
            const counts = levels.map(level => 
                filteredOccurrences.filter(o => o.level == level).length
            );
            
            const backgroundColors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(220, 53, 69, 0.7)'
            ];
            
            const ctx = document.getElementById('levelDistributionChart').getContext('2d');
            
            if (charts.levelDistribution) {
                charts.levelDistribution.data.datasets[0].data = counts;
                charts.levelDistribution.update();
            } else {
                charts.levelDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: levels.map(l => `Nível ${l}`),
                        datasets: [{
                            data: counts,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${value} ocorrência(s) (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        // Gráfico de Causas Raiz
        function updateRootCauseChart() {
            const causes = ['Estrutural', 'Comportamental', 'Outro'];
            const counts = causes.map(cause => 
                filteredOccurrences.filter(o => 
                    o.answers && o.answers.rootCause === cause
                ).length
            );
            
            const ctx = document.getElementById('rootCauseChart').getContext('2d');
            
            if (charts.rootCause) {
                charts.rootCause.data.datasets[0].data = counts;
                charts.rootCause.update();
            } else {
                charts.rootCause = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: causes,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Efeitos Gerados
        function updateEffectChart() {
            const effects = ['Batida de empilhadeira contra estruturas'];
            const counts = effects.map(effect => 
                filteredOccurrences.filter(o => 
                    o.answers && o.answers.main_effect === effect
                ).length
            );
            
            const ctx = document.getElementById('effectChart').getContext('2d');
            
            if (charts.effect) {
                charts.effect.data.datasets[0].data = counts;
                charts.effect.update();
            } else {
                charts.effect = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: effects,
                        datasets: [{
                            label: 'Ocorrências',
                            data: counts,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Ocorrências'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Efeito Gerado'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Tipos de Causa Estrutural
        function updateStructuralCauseChart() {
            const causes = ['Falta de equipamento', 'Falha no equipamento'];
            const counts = causes.map(cause => 
                filteredOccurrences.filter(o => 
                    o.answers && 
                    o.answers.rootCause === 'Estrutural' && 
                    o.answers.structural_problem === cause
                ).length
            );
            
            const ctx = document.getElementById('structuralCauseChart').getContext('2d');
            
            if (charts.structuralCause) {
                charts.structuralCause.data.datasets[0].data = counts;
                charts.structuralCause.update();
            } else {
                charts.structuralCause = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: causes,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Tipos de Causa Comportamental
        function updateBehavioralCauseChart() {
            const causes = [
                'Falha na execução do procedimento',
                'Falha na percepção de risco geral',
                'Falha no uso correto dos EPIs'
            ];
            
            const counts = causes.map(cause => 
                filteredOccurrences.filter(o => 
                    o.answers && 
                    o.answers.rootCause === 'Comportamental' && 
                    o.answers.behavioral_problem === cause
                ).length
            );
            
            const ctx = document.getElementById('behavioralCauseChart').getContext('2d');
            
            if (charts.behavioralCause) {
                charts.behavioralCause.data.datasets[0].data = counts;
                charts.behavioralCause.update();
            } else {
                charts.behavioralCause = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: causes,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(255, 99, 132, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Atualiza a tabela de ocorrências
        function updateTable() {
            const tableBody = document.getElementById('occurrencesTableBody');
            tableBody.innerHTML = '';
            
            filteredOccurrences.forEach(occurrence => {
                const row = document.createElement('tr');
                
                // Formata a data
                const date = new Date(occurrence.date);
                const formattedDate = date.toLocaleString('pt-BR');
                
                // Obtém a causa raiz
                let causeBadge = '';
                if (occurrence.answers && occurrence.answers.rootCause) {
                    const causeClass = occurrence.answers.rootCause === 'Estrutural' ? 'cause-structural' : 
                                      occurrence.answers.rootCause === 'Comportamental' ? 'cause-behavioral' : '';
                    causeBadge = `<span class="cause-badge ${causeClass}">${occurrence.answers.rootCause}</span>`;
                    
                    // Adiciona detalhes da causa se disponível
                    if (occurrence.answers.rootCause === 'Estrutural' && occurrence.answers.structural_problem) {
                        causeBadge += `<span class="cause-badge cause-structural">${occurrence.answers.structural_problem}</span>`;
                    }
                    if (occurrence.answers.rootCause === 'Comportamental' && occurrence.answers.behavioral_problem) {
                        causeBadge += `<span class="cause-badge cause-behavioral">${occurrence.answers.behavioral_problem}</span>`;
                    }
                }
                
                // Obtém o efeito gerado
                let effectBadge = '';
                if (occurrence.answers && occurrence.answers.main_effect) {
                    effectBadge = `<span class="effect-badge">${occurrence.answers.main_effect}</span>`;
                    
                    // Adiciona detalhes do efeito se disponível
                    if (occurrence.answers.main_effect === 'Batida de empilhadeira contra estruturas' && 
                        occurrence.answers.hit_structure) {
                        effectBadge += `<span class="effect-badge">${occurrence.answers.hit_structure}</span>`;
                    }
                }
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${occurrence.location || 'N/A'}</td>
                    <td>${occurrence.occurrenceType || 'N/A'}</td>
                    <td><span class="level-badge level-${occurrence.level}">${occurrence.level}</span></td>
                    <td>${causeBadge || 'N/A'}</td>
                    <td>${effectBadge || 'N/A'}</td>
                    <td>${occurrence.responsibleName || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-details" data-id="${occurrence.id}">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Adiciona eventos aos botões de detalhes
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const occurrenceId = this.getAttribute('data-id');
                    showOccurrenceDetails(occurrenceId);
                });
            });
        }

        // Mostra os detalhes de uma ocorrência no modal
        function showOccurrenceDetails(occurrenceId) {
            const occurrence = allOccurrences.find(o => o.id === occurrenceId);
            
            if (!occurrence) return;
            
            const modalContent = document.getElementById('occurrenceDetailContent');
            const date = new Date(occurrence.date);
            const formattedDate = date.toLocaleString('pt-BR');
            
            // Prepara os detalhes da causa raiz
            let causeDetails = '';
            if (occurrence.answers && occurrence.answers.rootCause) {
                causeDetails = `
                    <h5 class="mt-4">Causa Raiz</h5>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">Categoria</th>
                                <td>${occurrence.answers.rootCause || 'N/A'}</td>
                            </tr>
                `;
                
                if (occurrence.answers.rootCause === 'Estrutural') {
                    causeDetails += `
                        <tr>
                            <th>Problema Estrutural</th>
                            <td>${occurrence.answers.structural_problem || 'N/A'}</td>
                        </tr>
                    `;
                    
                    if (occurrence.answers.structural_problem === 'Falta de equipamento') {
                        causeDetails += `
                            <tr>
                                <th>Descrição da Falta</th>
                                <td>${occurrence.answers.missingEquipmentDescription || 'N/A'}</td>
                            </tr>
                        `;
                    } else if (occurrence.answers.structural_problem === 'Falha no equipamento') {
                        causeDetails += `
                            <tr>
                                <th>Descrição da Falha</th>
                                <td>${occurrence.answers.equipmentFailureDescription || 'N/A'}</td>
                            </tr>
                        `;
                    }
                } else if (occurrence.answers.rootCause === 'Comportamental') {
                    causeDetails += `
                        <tr>
                            <th>Problema Comportamental</th>
                            <td>${occurrence.answers.behavioral_problem || 'N/A'}</td>
                        </tr>
                    `;
                    
                    if (occurrence.answers.behavioral_problem === 'Falha na execução do procedimento') {
                        causeDetails += `
                            <tr>
                                <th>Falha Específica</th>
                                <td>${occurrence.answers.procedure_failure || 'N/A'}</td>
                            </tr>
                        `;
                    }
                } else if (occurrence.answers.rootCause === 'Outro') {
                    causeDetails += `
                        <tr>
                            <th>Descrição</th>
                            <td>${occurrence.answers.otherCauseDescription || 'N/A'}</td>
                        </tr>
                    `;
                }
                
                causeDetails += `</tbody></table>`;
            }
            
            // Prepara os detalhes do efeito gerado
            let effectDetails = '';
            if (occurrence.answers && occurrence.answers.main_effect) {
                effectDetails = `
                    <h5 class="mt-4">Efeito Gerado</h5>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">Efeito Principal</th>
                                <td>${occurrence.answers.main_effect || 'N/A'}</td>
                            </tr>
                `;
                
                if (occurrence.answers.main_effect === 'Batida de empilhadeira contra estruturas') {
                    effectDetails += `
                        <tr>
                            <th>Estrutura Atingida</th>
                            <td>${occurrence.answers.hit_structure || 'N/A'}</td>
                        </tr>
                    `;
                }
                
                effectDetails += `</tbody></table>`;
            }
            
            // Prepara os detalhes das respostas
            let answersHTML = '';
            if (occurrence.answers) {
                answersHTML = `
                    <h5 class="mt-4">Respostas do Formulário</h5>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">Houve vítimas?</th>
                                <td>${occurrence.answers.q1 || 'N/A'}</td>
                            </tr>
                            ${occurrence.answers.q1 === 'Sim' ? `
                                <tr>
                                    <th>Necessidade de atendimento médico?</th>
                                    <td>${occurrence.answers.q1_1 || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <th>Tipo de lesão</th>
                                    <td>${occurrence.answers.q1_2 || 'N/A'}</td>
                                </tr>
                            ` : ''}
                            <tr>
                                <th>Houve danos à estrutura?</th>
                                <td>${occurrence.answers.q2 || 'N/A'}</td>
                            </tr>
                            ${occurrence.answers.q2 === 'Sim' ? `
                                <tr>
                                    <th>Danos com custo para a empresa?</th>
                                    <td>${occurrence.answers.q2_1 || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <th>Nível de dano à estrutura</th>
                                    <td>${occurrence.answers.q2_2 || 'N/A'}</td>
                                </tr>
                            ` : ''}
                            <tr>
                                <th>Houve descumprimento das Regras de Ouro?</th>
                                <td>${occurrence.answers.q3 || 'N/A'}</td>
                            </tr>
                            ${occurrence.answers.q3 === 'Sim' ? `
                                <tr>
                                    <th>Regra descumprida</th>
                                    <td>${occurrence.answers.q3_1 || 'N/A'}</td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                `;
            }
            
            // Prepara a descrição completa
            let descriptionHTML = '';
            if (occurrence.description) {
                descriptionHTML = `
                    <h5 class="mt-4">Descrição Completa</h5>
                    <div class="card">
                        <div class="card-body">
                            <p>${occurrence.description.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Data/Hora:</strong> ${formattedDate}</p>
                        <p><strong>Local:</strong> ${occurrence.location || 'N/A'}</p>
                        <p><strong>Responsável:</strong> ${occurrence.responsibleName || 'N/A'}</p>
                        <p><strong>Registrado por:</strong> ${occurrence.userEmail || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Tipo de Ocorrência:</strong> ${occurrence.occurrenceType || 'N/A'}</p>
                        <p><strong>Nível:</strong> <span class="level-badge level-${occurrence.level}">${occurrence.level}</span></p>
                        <p><strong>Plano de Ação:</strong> ${occurrence.actionPlan || 'N/A'}</p>
                        <p><strong>Data do Registro:</strong> ${new Date(occurrence.timestamp).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
                ${descriptionHTML}
                ${causeDetails}
                ${effectDetails}
                ${answersHTML}
            `;
            
            // Mostra o modal
            const modal = new bootstrap.Modal(document.getElementById('occurrenceDetailModal'));
            modal.show();
        }

        // Exporta os dados para Excel
        function exportData() {
            // Prepara os dados para exportação
            const dataToExport = filteredOccurrences.map(occurrence => {
                const date = new Date(occurrence.date);
                const formattedDate = date.toLocaleString('pt-BR');
                
                return {
                    'Data/Hora': formattedDate,
                    'Local': occurrence.location || 'N/A',
                    'Tipo de Ocorrência': occurrence.occurrenceType || 'N/A',
                    'Nível': occurrence.level,
                    'Descrição': occurrence.description || 'N/A',
                    'Responsável': occurrence.responsibleName || 'N/A',
                    'Registrado por': occurrence.userEmail || 'N/A',
                    'Causa Raiz': occurrence.answers?.rootCause || 'N/A',
                    'Problema Estrutural': occurrence.answers?.structural_problem || 'N/A',
                    'Descrição Falta Equipamento': occurrence.answers?.missingEquipmentDescription || 'N/A',
                    'Descrição Falha Equipamento': occurrence.answers?.equipmentFailureDescription || 'N/A',
                    'Problema Comportamental': occurrence.answers?.behavioral_problem || 'N/A',
                    'Falha Específica': occurrence.answers?.procedure_failure || 'N/A',
                    'Outra Causa': occurrence.answers?.otherCauseDescription || 'N/A',
                    'Efeito Principal': occurrence.answers?.main_effect || 'N/A',
                    'Estrutura Atingida': occurrence.answers?.hit_structure || 'N/A',
                    'Houve vítimas?': occurrence.answers?.q1 || 'N/A',
                    'Atendimento médico necessário?': occurrence.answers?.q1_1 || 'N/A',
                    'Tipo de lesão': occurrence.answers?.q1_2 || 'N/A',
                    'Houve danos estruturais?': occurrence.answers?.q2 || 'N/A',
                    'Danos com custo?': occurrence.answers?.q2_1 || 'N/A',
                    'Nível de danos': occurrence.answers?.q2_2 || 'N/A',
                    'Descumprimento de regras?': occurrence.answers?.q3 || 'N/A',
                    'Regra descumprida': occurrence.answers?.q3_1 || 'N/A',
                    'Plano de Ação': occurrence.actionPlan || 'N/A',
                    'Data do Registro': new Date(occurrence.timestamp).toLocaleString('pt-BR')
                };
            });
            
            // Cria a planilha
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ocorrências');
            
            // Gera o arquivo e faz o download
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `ocorrencias_${dateStr}.xlsx`);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ocorrências</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .level-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .level-1 { background-color: #e6f7ff; color: #004085; }
        .level-2 { background-color: #fff3cd; color: #856404; }
        .level-3 { background-color: #ffeeba; color: #856404; }
        .level-4 { background-color: #f8d7da; color: #721c24; }
        .level-5 { background-color: #dc3545; color: white; }
        .occurrence-table {
            font-size: 0.9rem;
        }
        .occurrence-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .export-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-exclamation-triangle"></i> Dashboard de Ocorrências</h1>
                    <p class="mb-0">Análise detalhada das ocorrências registradas</p>
                </div>
                <div class="col-md-4 text-end">
                    <button id="exportData" class="btn btn-light">
                        <i class="fas fa-download"></i> Exportar Dados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label for="locationFilter" class="form-label">Unidade</label>
                    <select id="locationFilter" class="form-select">
                        <option value="all">Todas as unidades</option>
                        <option value="Fabrica Suzano Belem">Fábrica Suzano Belém</option>
                        <option value="Fabrica Suzano Limeira">Fábrica Suzano Limeira</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="dateRange" class="form-label">Período</label>
                    <input type="text" class="form-control" id="dateRange" placeholder="Selecione o período">
                </div>
                <div class="col-md-4">
                    <label for="levelFilter" class="form-label">Nível de Ocorrência</label>
                    <select id="levelFilter" class="form-select">
                        <option value="all">Todos os níveis</option>
                        <option value="1">Nível 1</option>
                        <option value="2">Nível 2</option>
                        <option value="3">Nível 3</option>
                        <option value="4">Nível 4</option>
                        <option value="5">Nível 5</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="typeFilter" class="form-label">Tipo de Ocorrência</label>
                    <select id="typeFilter" class="form-select">
                        <option value="all">Todos os tipos</option>
                        <option value="Ocorrência com vítimas">Com vítimas</option>
                        <option value="Ocorrência com danos estruturais">Com danos estruturais</option>
                        <option value="Descumprimento das Regras de Ouro">Descumprimento de regras</option>
                        <option value="Ocorrência com vítimas e danos estruturais">Vítimas e danos</option>
                    </select>
                </div>
                <div class="col-md-8 d-flex align-items-end">
                    <button id="applyFilters" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                    <button id="resetFilters" class="btn btn-outline-secondary export-btn">
                        <i class="fas fa-undo"></i> Limpar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="totalOccurrences">0</div>
                    <div class="stat-label">Total de Ocorrências</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="avgLevel">0</div>
                    <div class="stat-label">Nível Médio</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="victimOccurrences">0</div>
                    <div class="stat-label">Com Vítimas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="structureOccurrences">0</div>
                    <div class="stat-label">Com Danos</div>
                </div>
            </div>
        </div>

        <!-- Gráficos e Tabelas -->
        <div class="row mt-4">
            <!-- Gráfico 1: Ocorrências por Dia -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Ocorrências por Dia
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dailyOccurrencesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico 2: Distribuição por Nível -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Distribuição por Nível de Gravidade
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="levelDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Gráfico 3: Tipos de Ocorrência -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Tipos de Ocorrência
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="typeDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico 4: Ocorrências por Local -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Ocorrências por Local
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="locationDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Gráfico 5: Regras de Ouro Violadas -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Regras de Ouro Violadas
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="goldenRulesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico 6: Tendência Mensal -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Tendência Mensal de Ocorrências
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Ocorrências -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Detalhes das Ocorrências
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover occurrence-table">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Local</th>
                                        <th>Tipo</th>
                                        <th>Nível</th>
                                        <th>Responsável</th>
                                        <th>Vítimas</th>
                                        <th>Danos</th>
                                        <th>Regras Violadas</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="occurrencesTableBody">
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalhes da Ocorrência -->
    <div class="modal fade" id="occurrenceDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Ocorrência</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="occurrenceDetailContent">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase e Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDZwa4XNqlupNDLs7-CRQbhr5pRT4NyFBA",
            authDomain: "application-gzl.firebaseapp.com",
            databaseURL: "https://application-gzl-default-rtdb.firebaseio.com",
            projectId: "application-gzl",
            storageBucket: "application-gzl.firebasestorage.app",
            messagingSenderId: "319900903265",
            appId: "1:319900903265:web:a8f400aeb7a697fc168720",
            measurementId: "G-ZRRFQZXT54"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Variáveis globais
        let allOccurrences = [];
        let filteredOccurrences = [];
        let charts = {};

        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Configura o date range picker
            flatpickr("#dateRange", {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: "pt",
                defaultDate: [new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), new Date()]
            });

            // Carrega os dados do Firebase
            loadOccurrencesData();

            // Configura os eventos dos botões
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('exportData').addEventListener('click', exportData);
        });

        // Carrega os dados das ocorrências do Firebase
        function loadOccurrencesData() {
            const occurrencesRef = database.ref('occurrences');
            
            occurrencesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                allOccurrences = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        const occurrence = data[key];
                        occurrence.id = key;
                        allOccurrences.push(occurrence);
                    });
                }
                
                // Ordena por data (mais recente primeiro)
                allOccurrences.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Aplica os filtros padrão
                applyFilters();
            });
        }

        // Aplica os filtros selecionados
        function applyFilters() {
            const locationFilter = document.getElementById('locationFilter').value;
            const dateRange = document.getElementById('dateRange')._flatpickr.selectedDates;
            const levelFilter = document.getElementById('levelFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredOccurrences = allOccurrences.filter(occurrence => {
                // Filtro por local
                if (locationFilter !== 'all' && occurrence.location !== locationFilter) {
                    return false;
                }
                
                // Filtro por data
                if (dateRange.length === 2) {
                    const occurrenceDate = new Date(occurrence.date);
                    const startDate = new Date(dateRange[0]);
                    const endDate = new Date(dateRange[1]);
                    
                    // Ajusta a data final para incluir todo o dia
                    endDate.setHours(23, 59, 59, 999);
                    
                    if (occurrenceDate < startDate || occurrenceDate > endDate) {
                        return false;
                    }
                }
                
                // Filtro por nível
                if (levelFilter !== 'all' && occurrence.level != levelFilter) {
                    return false;
                }
                
                // Filtro por tipo
                if (typeFilter !== 'all' && !occurrence.occurrenceType.includes(typeFilter)) {
                    return false;
                }
                
                return true;
            });
            
            // Atualiza as estatísticas e gráficos
            updateStatistics();
            updateCharts();
            updateTable();
        }

        // Reseta todos os filtros
        function resetFilters() {
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('dateRange')._flatpickr.clear();
            
            applyFilters();
        }

        // Atualiza as estatísticas
        function updateStatistics() {
            const total = filteredOccurrences.length;
            document.getElementById('totalOccurrences').textContent = total;
            
            // Calcula o nível médio
            const avgLevel = total > 0 
                ? (filteredOccurrences.reduce((sum, o) => sum + parseInt(o.level), 0) / total).toFixed(1)
                : 0;
            document.getElementById('avgLevel').textContent = avgLevel;
            
            // Conta ocorrências com vítimas
            const withVictims = filteredOccurrences.filter(o => 
                o.answers && o.answers.q1 === 'Sim').length;
            document.getElementById('victimOccurrences').textContent = withVictims;
            
            // Conta ocorrências com danos estruturais
            const withDamage = filteredOccurrences.filter(o => 
                o.answers && o.answers.q2 === 'Sim').length;
            document.getElementById('structureOccurrences').textContent = withDamage;
        }

        // Atualiza os gráficos
        function updateCharts() {
            updateDailyOccurrencesChart();
            updateLevelDistributionChart();
            updateTypeDistributionChart();
            updateLocationDistributionChart();
            updateGoldenRulesChart();
            updateMonthlyTrendChart();
        }

        // Gráfico de Ocorrências por Dia
        function updateDailyOccurrencesChart() {
            const dateRange = document.getElementById('dateRange')._flatpickr.selectedDates;
            let days = [];
            let counts = [];
            
            if (dateRange.length === 2) {
                const startDate = new Date(dateRange[0]);
                const endDate = new Date(dateRange[1]);
                
                // Cria um array com todos os dias no intervalo
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    days.push(dateStr);
                    counts.push(0);
                }
                
                // Conta as ocorrências por dia
                filteredOccurrences.forEach(o => {
                    const occurrenceDate = new Date(o.date);
                    const dateStr = occurrenceDate.toISOString().split('T')[0];
                    const index = days.indexOf(dateStr);
                    
                    if (index !== -1) {
                        counts[index]++;
                    }
                });
            } else {
                // Se não houver intervalo definido, agrupa por dia para todas as ocorrências
                const dailyCounts = {};
                
                filteredOccurrences.forEach(o => {
                    const occurrenceDate = new Date(o.date);
                    const dateStr = occurrenceDate.toISOString().split('T')[0];
                    
                    if (!dailyCounts[dateStr]) {
                        dailyCounts[dateStr] = 0;
                    }
                    dailyCounts[dateStr]++;
                });
                
                days = Object.keys(dailyCounts).sort();
                counts = days.map(date => dailyCounts[date]);
            }
            
            // Formata as datas para exibição
            const formattedDays = days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('pt-BR');
            });
            
            const ctx = document.getElementById('dailyOccurrencesChart').getContext('2d');
            
            if (charts.dailyOccurrences) {
                charts.dailyOccurrences.data.labels = formattedDays;
                charts.dailyOccurrences.data.datasets[0].data = counts;
                charts.dailyOccurrences.update();
            } else {
                charts.dailyOccurrences = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: formattedDays,
                        datasets: [{
                            label: 'Ocorrências por Dia',
                            data: counts,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Ocorrências'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Data'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Distribuição por Nível
        function updateLevelDistributionChart() {
            const levels = [1, 2, 3, 4, 5];
            const counts = levels.map(level => 
                filteredOccurrences.filter(o => o.level == level).length
            );
            
            const backgroundColors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(220, 53, 69, 0.7)'
            ];
            
            const ctx = document.getElementById('levelDistributionChart').getContext('2d');
            
            if (charts.levelDistribution) {
                charts.levelDistribution.data.datasets[0].data = counts;
                charts.levelDistribution.update();
            } else {
                charts.levelDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: levels.map(l => `Nível ${l}`),
                        datasets: [{
                            data: counts,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${value} ocorrência(s) (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        // Gráfico de Distribuição por Tipo
        function updateTypeDistributionChart() {
            const typeCounts = {};
            
            filteredOccurrences.forEach(o => {
                const type = o.occurrenceType || 'Outro';
                if (!typeCounts[type]) {
                    typeCounts[type] = 0;
                }
                typeCounts[type]++;
            });
            
            const types = Object.keys(typeCounts);
            const counts = types.map(type => typeCounts[type]);
            
            const ctx = document.getElementById('typeDistributionChart').getContext('2d');
            
            if (charts.typeDistribution) {
                charts.typeDistribution.data.labels = types;
                charts.typeDistribution.data.datasets[0].data = counts;
                charts.typeDistribution.update();
            } else {
                charts.typeDistribution = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: types,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.raw;
                                        const percentage = Math.round((value / total) * 100);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Distribuição por Local
        function updateLocationDistributionChart() {
            const locationCounts = {};
            
            filteredOccurrences.forEach(o => {
                const location = o.location || 'Desconhecido';
                if (!locationCounts[location]) {
                    locationCounts[location] = 0;
                }
                locationCounts[location]++;
            });
            
            const locations = Object.keys(locationCounts);
            const counts = locations.map(location => locationCounts[location]);
            
            const ctx = document.getElementById('locationDistributionChart').getContext('2d');
            
            if (charts.locationDistribution) {
                charts.locationDistribution.data.labels = locations;
                charts.locationDistribution.data.datasets[0].data = counts;
                charts.locationDistribution.update();
            } else {
                charts.locationDistribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: locations,
                        datasets: [{
                            label: 'Ocorrências por Local',
                            data: counts,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Ocorrências'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Local'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Regras de Ouro Violadas
        function updateGoldenRulesChart() {
            const ruleCounts = {};
            
            filteredOccurrences.forEach(o => {
                if (o.answers && o.answers.q3 === 'Sim' && o.answers.q3_1) {
                    const rule = o.answers.q3_1;
                    if (!ruleCounts[rule]) {
                        ruleCounts[rule] = 0;
                    }
                    ruleCounts[rule]++;
                }
            });
            
            const rules = Object.keys(ruleCounts);
            const counts = rules.map(rule => ruleCounts[rule]);
            
            const ctx = document.getElementById('goldenRulesChart').getContext('2d');
            
            if (charts.goldenRules) {
                charts.goldenRules.data.labels = rules;
                charts.goldenRules.data.datasets[0].data = counts;
                charts.goldenRules.update();
            } else {
                charts.goldenRules = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: rules,
                        datasets: [{
                            label: 'Regras Violadas',
                            data: counts,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(199, 199, 199, 0.7)',
                                'rgba(83, 102, 255, 0.7)',
                                'rgba(40, 167, 69, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Gráfico de Tendência Mensal
        function updateMonthlyTrendChart() {
            const monthNames = [
                'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
            ];
            
            const monthlyCounts = {};
            
            // Inicializa todos os meses com zero
            const allMonths = [];
            const currentDate = new Date();
            const earliestDate = filteredOccurrences.length > 0 
                ? new Date(filteredOccurrences[filteredOccurrences.length - 1].date) 
                : new Date();
            
            for (let d = new Date(earliestDate); d <= currentDate; d.setMonth(d.getMonth() + 1)) {
                const monthYear = `${monthNames[d.getMonth()]}/${d.getFullYear()}`;
                allMonths.push(monthYear);
                monthlyCounts[monthYear] = 0;
            }
            
            // Conta as ocorrências por mês
            filteredOccurrences.forEach(o => {
                const occurrenceDate = new Date(o.date);
                const monthYear = `${monthNames[occurrenceDate.getMonth()]}/${occurrenceDate.getFullYear()}`;
                
                if (monthlyCounts[monthYear] !== undefined) {
                    monthlyCounts[monthYear]++;
                }
            });
            
            const counts = allMonths.map(month => monthlyCounts[month]);
            
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            if (charts.monthlyTrend) {
                charts.monthlyTrend.data.labels = allMonths;
                charts.monthlyTrend.data.datasets[0].data = counts;
                charts.monthlyTrend.update();
            } else {
                charts.monthlyTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allMonths,
                        datasets: [{
                            label: 'Ocorrências Mensais',
                            data: counts,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Ocorrências'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Mês/Ano'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} ocorrência(s)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Atualiza a tabela de ocorrências
        function updateTable() {
            const tableBody = document.getElementById('occurrencesTableBody');
            tableBody.innerHTML = '';
            
            filteredOccurrences.forEach(occurrence => {
                const row = document.createElement('tr');
                
                // Formata a data
                const date = new Date(occurrence.date);
                const formattedDate = date.toLocaleString('pt-BR');
                
                // Verifica se há vítimas
                const hasVictims = occurrence.answers && occurrence.answers.q1 === 'Sim';
                const victimInfo = hasVictims 
                    ? `${occurrence.answers.q1_1 === 'Sim' ? 'Com atendimento' : 'Sem atendimento'}, ${occurrence.answers.q1_2 || 'N/A'}` 
                    : 'Não';
                
                // Verifica se há danos
                const hasDamage = occurrence.answers && occurrence.answers.q2 === 'Sim';
                const damageInfo = hasDamage 
                    ? `${occurrence.answers.q2_1 === 'Sim' ? 'Com custo' : 'Sem custo'}, ${occurrence.answers.q2_2 || 'N/A'}` 
                    : 'Não';
                
                // Verifica se há regras violadas
                const hasGoldenRule = occurrence.answers && occurrence.answers.q3 === 'Sim';
                const goldenRuleInfo = hasGoldenRule 
                    ? occurrence.answers.q3_1 || 'Regra não especificada' 
                    : 'Não';
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${occurrence.location || 'N/A'}</td>
                    <td>${occurrence.occurrenceType || 'N/A'}</td>
                    <td><span class="level-badge level-${occurrence.level}">${occurrence.level}</span></td>
                    <td>${occurrence.responsibleName || 'N/A'}</td>
                    <td>${victimInfo}</td>
                    <td>${damageInfo}</td>
                    <td>${goldenRuleInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-details" data-id="${occurrence.id}">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Adiciona eventos aos botões de detalhes
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const occurrenceId = this.getAttribute('data-id');
                    showOccurrenceDetails(occurrenceId);
                });
            });
        }

        // Mostra os detalhes de uma ocorrência no modal
        function showOccurrenceDetails(occurrenceId) {
            const occurrence = allOccurrences.find(o => o.id === occurrenceId);
            
            if (!occurrence) return;
            
            const modalContent = document.getElementById('occurrenceDetailContent');
            const date = new Date(occurrence.date);
            const formattedDate = date.toLocaleString('pt-BR');
            
            // Prepara os detalhes das respostas
            let answersHTML = '';
            if (occurrence.answers) {
                answersHTML = `
                    <h5 class="mt-4">Respostas do Formulário</h5>
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th width="30%">Houve vítimas?</th>
                                <td>${occurrence.answers.q1 || 'N/A'}</td>
                            </tr>
                            ${occurrence.answers.q1 === 'Sim' ? `
                                <tr>
                                    <th>Necessidade de atendimento médico?</th>
                                    <td>${occurrence.answers.q1_1 || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <th>Tipo de lesão</th>
                                    <td>${occurrence.answers.q1_2 || 'N/A'}</td>
                                </tr>
                            ` : ''}
                            <tr>
                                <th>Houve danos à estrutura?</th>
                                <td>${occurrence.answers.q2 || 'N/A'}</td>
                            </tr>
                            ${occurrence.answers.q2 === 'Sim' ? `
                                <tr>
                                    <th>Danos com custo para a empresa?</th>
                                    <td>${occurrence.answers.q2_1 || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <th>Nível de dano à estrutura</th>
                                    <td>${occurrence.answers.q2_2 || 'N/A'}</td>
                                </tr>
                            ` : ''}
                            <tr>
                                <th>Houve descumprimento das Regras de Ouro?</th>
                                <td>${occurrence.answers.q3 || 'N/A'}</td>
                            </tr>
                            ${occurrence.answers.q3 === 'Sim' ? `
                                <tr>
                                    <th>Regra descumprida</th>
                                    <td>${occurrence.answers.q3_1 || 'N/A'}</td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                `;
            }
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Data/Hora:</strong> ${formattedDate}</p>
                        <p><strong>Local:</strong> ${occurrence.location || 'N/A'}</p>
                        <p><strong>Responsável:</strong> ${occurrence.responsibleName || 'N/A'}</p>
                        <p><strong>Registrado por:</strong> ${occurrence.userEmail || 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Tipo de Ocorrência:</strong> ${occurrence.occurrenceType || 'N/A'}</p>
                        <p><strong>Nível:</strong> <span class="level-badge level-${occurrence.level}">${occurrence.level}</span></p>
                        <p><strong>Plano de Ação:</strong> ${occurrence.actionPlan || 'N/A'}</p>
                        <p><strong>Data do Registro:</strong> ${new Date(occurrence.timestamp).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
                ${answersHTML}
            `;
            
            // Mostra o modal
            const modal = new bootstrap.Modal(document.getElementById('occurrenceDetailModal'));
            modal.show();
        }

        // Exporta os dados para Excel
        function exportData() {
            // Prepara os dados para exportação
            const dataToExport = filteredOccurrences.map(occurrence => {
                const date = new Date(occurrence.date);
                const formattedDate = date.toLocaleString('pt-BR');
                
                return {
                    'Data/Hora': formattedDate,
                    'Local': occurrence.location || 'N/A',
                    'Tipo de Ocorrência': occurrence.occurrenceType || 'N/A',
                    'Nível': occurrence.level,
                    'Responsável': occurrence.responsibleName || 'N/A',
                    'Registrado por': occurrence.userEmail || 'N/A',
                    'Houve vítimas?': occurrence.answers?.q1 || 'N/A',
                    'Atendimento médico necessário?': occurrence.answers?.q1_1 || 'N/A',
                    'Tipo de lesão': occurrence.answers?.q1_2 || 'N/A',
                    'Houve danos estruturais?': occurrence.answers?.q2 || 'N/A',
                    'Danos com custo?': occurrence.answers?.q2_1 || 'N/A',
                    'Nível de danos': occurrence.answers?.q2_2 || 'N/A',
                    'Descumprimento de regras?': occurrence.answers?.q3 || 'N/A',
                    'Regra descumprida': occurrence.answers?.q3_1 || 'N/A',
                    'Plano de Ação': occurrence.actionPlan || 'N/A',
                    'Data do Registro': new Date(occurrence.timestamp).toLocaleString('pt-BR')
                };
            });
            
            // Cria a planilha
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ocorrências');
            
            // Gera o arquivo e faz o download
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `ocorrencias_${dateStr}.xlsx`);
        }
    </script>
</body>
</html>
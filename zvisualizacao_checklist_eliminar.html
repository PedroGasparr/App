<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklists para Eliminação</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="wvisualizacao_checklist_eliminar.css">
    <link rel="icon" href="img/social-media.gif" type="image/x-icon">
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-shield-alt"></i> Checklists para Eliminação</h1>
        <p>Registros de incidentes e não conformidades</p>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label for="dateFilter">Filtrar por Data:</label>
            <input type="date" id="dateFilter">
        </div>
        <div class="filter-group">
            <label for="employeeFilter">Filtrar por Funcionário:</label>
            <input type="text" id="employeeFilter" placeholder="Nome do funcionário">
        </div>
        <div class="filter-group status-filter">
            <label for="statusFilter">Filtrar por Status:</label>
            <select id="statusFilter">
                <option value="">Todos</option>
                <option value="pendente">Pendente</option>
                <option value="processo">Em Processo</option>
                <option value="concluido">Concluído</option>
            </select>
        </div>
    </div>

    <div class="records-container" id="recordsContainer">
        <div class="loading">Carregando registros...</div>
    </div>

    <!-- Modal para senha de administrador -->
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <h3>Digite a senha de administrador</h3>
            <input type="password" id="adminPassword" placeholder="Senha de administrador">
            <div class="password-modal-buttons">
                <button class="password-modal-cancel" id="cancelDelete">Cancelar</button>
                <button class="password-modal-confirm" id="confirmDelete">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZwa4XNqlupNDLs7-CRQbhr5pRT4NyFBA",
            authDomain: "application-gzl.firebaseapp.com",
            databaseURL: "https://application-gzl-default-rtdb.firebaseio.com",
            projectId: "application-gzl",
            storageBucket: "application-gzl.firebasestorage.app",
            messagingSenderId: "319900903265",
            appId: "1:319900903265:web:a8f400aeb7a697fc168720",
            measurementId: "G-ZRRFQZXT54"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
    
        // Format date for display
        function formatDisplayDate(dateString) {
            if (!dateString) return 'Não informado';
            try {
                const date = new Date(dateString);
                return isNaN(date) ? 'Data inválida' : date.toLocaleDateString('pt-BR');
            } catch {
                return 'Data inválida';
            }
        }
    
        // Format date for comparison (YYYY-MM-DD)
        function formatDateForComparison(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }
    
        // Filter and sort records
        function processRecords(data, dateFilter, employeeFilter, statusFilter) {
            if (!data) return [];
            
            return Object.entries(data)
                .map(([key, record]) => ({ 
                    key, 
                    ...record,
                    status: record.status || 'pendente'
                }))
                .filter(record => {
                    const dateMatch = !dateFilter || 
                        formatDateForComparison(record.date) === dateFilter;
                    
                    const employeeMatch = !employeeFilter || 
                        (record.employee && record.employee.name && 
                         record.employee.name.toLowerCase().includes(employeeFilter.toLowerCase()));
                    
                    const statusMatch = !statusFilter || 
                        (record.status && record.status.toLowerCase() === statusFilter.toLowerCase());
                    
                    return dateMatch && employeeMatch && statusMatch;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }
    
        // Get status badge HTML
        function getStatusBadge(status) {
            const statusText = status || 'pendente';
            const statusClass = {
                'pendente': 'status-pendente',
                'processo': 'status-processo',
                'concluido': 'status-concluido'
            }[statusText.toLowerCase()] || 'status-pendente';
            
            return `<span class="status-badge ${statusClass}">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span>`;
        }
    
        // Display records
        function displayRecords(filteredRecords) {
            const recordsContainer = document.getElementById('recordsContainer');
            recordsContainer.innerHTML = '';
    
            if (filteredRecords.length === 0) {
                recordsContainer.innerHTML = '<div class="no-records">Nenhum registro encontrado</div>';
                return;
            }
    
            filteredRecords.forEach(record => {
                const recordCard = document.createElement('div');
                recordCard.className = 'record-card';
                
                // Format employee info
                const employeeInfo = record.employee || {};
                const status = record.status || 'pendente';
                
                // Format answers
                let answersHTML = '';
                if (record.answers) {
                    answersHTML = `
                        <div class="answers-section">
                            <h3 class="section-title">Detalhes do Incidente</h3>
                            <!-- Seção de perguntas e respostas mantida igual -->
                        </div>
                    `;
                }
                
                // Format action plan
                const actionPlanHTML = record.actionPlan ? `
                    <div class="action-plan">
                        <h4><i class="fas fa-exclamation-triangle"></i> Plano de Ação:</h4>
                        <p>${record.actionPlan}</p>
                    </div>
                ` : '';
                
                // Format finalization section
                const finalizationHTML = `
                    <div class="finalization-section">
                        <h4><i class="fas fa-clipboard-check"></i> Finalização ${getStatusBadge(status)}</h4>
                        <textarea class="finalization-textarea" placeholder="Descreva como a situação foi corrigida..." 
                            ${status === 'concluido' ? 'readonly' : ''}>${record.finalization || ''}</textarea>
                        ${status !== 'concluido' ? `
                        <div class="finalization-buttons">
                            <button class="btn-save-later" data-record-id="${record.key}">
                                Salvar e Continuar Depois
                            </button>
                            <button class="btn-save-final" data-record-id="${record.key}">
                                Concluir Definitivamente
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Format occurrence and victim details - VERSÃO ATUALIZADA
                const occurrenceDetailsHTML = `
                    <div class="card-details">
                        <div class="occurrence-details">
                            <h4><i class="fas fa-car-crash"></i> Detalhes da Ocorrência</h4>
                            <div class="info-row">
                                <span class="info-label">Tipo de Ocorrência:</span>
                                <span class="info-value">${record.occurrenceType || 'Não informado'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Tipo:</span>
                                <span class="info-value">${record.type || 'Não informado'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Data e Hora:</span>
                                <span class="info-value">${formatDisplayDate(record.date)} ${record.time || ''}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Descrição:</span>
                                <span class="info-value">${record.description || 'Não informado'}</span>
                            </div>
                            
                            ${record.victim ? `
                            <div class="victim-section">
                                <h4><i class="fas fa-user-injured"></i> Informações da Vítima</h4>
                                <div class="info-row">
                                    <span class="info-label">Nome:</span>
                                    <span class="info-value danger-highlight">${record.victim.name || 'Não informado'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Tempo na Função:</span>
                                    <span class="info-value">${record.victim.timeInFunction || 'Não informado'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Jornada de Trabalho:</span>
                                    <span class="info-value">${record.victim.workJourney || 'Não informado'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Idade:</span>
                                    <span class="info-value">${record.victim.age || 'Não informado'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Função:</span>
                                    <span class="info-value">${record.victim.function || 'Não informado'}</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                recordCard.innerHTML = `
                    <button class="delete-btn" data-record-id="${record.key}">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div class="card-header">
                        <h3>${formatDisplayDate(record.date)} - ${employeeInfo.name || 'Sem nome'}</h3>
                        <button class="toggle-btn">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="info-label">Funcionário:</span>
                            <span class="info-value">${employeeInfo.name || 'Não informado'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Idade:</span>
                            <span class="info-value">${employeeInfo.age || 'Não informado'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Turno:</span>
                            <span class="info-value">${employeeInfo.workSchedule || 'Não informado'}</span>
                        </div>
                        
                        ${answersHTML}
                        ${actionPlanHTML}
                        ${finalizationHTML}
                    </div>
                    ${occurrenceDetailsHTML}
                `;
                
                recordsContainer.appendChild(recordCard);
            });
    
            // Event listeners (mantidos iguais)
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const recordId = btn.getAttribute('data-record-id');
                    showPasswordModal(recordId);
                });
            });
    
            document.querySelectorAll('.card-header').forEach(header => {
                header.addEventListener('click', () => {
                    const card = header.parentElement;
                    const details = card.querySelector('.card-details');
                    const toggleBtn = header.querySelector('.toggle-btn');
                    
                    if (details) {
                        details.classList.toggle('show');
                        toggleBtn.classList.toggle('rotated');
                    }
                });
            });
    
            document.querySelectorAll('.btn-save-later').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-record-id');
                    const card = this.closest('.record-card');
                    const textarea = card.querySelector('.finalization-textarea');
                    saveFinalization(recordId, textarea.value, 'processo');
                });
            });
    
            document.querySelectorAll('.btn-save-final').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-record-id');
                    const card = this.closest('.record-card');
                    const textarea = card.querySelector('.finalization-textarea');
                    saveFinalization(recordId, textarea.value, 'concluido');
                });
            });
        }
    
        // Função para salvar a finalização (mantida igual)
        function saveFinalization(recordId, finalizationText, status) {
            if (!finalizationText.trim()) {
                alert('Por favor, descreva como a situação foi corrigida.');
                return;
            }
    
            const updates = {
                [`DBrdeliminar/${recordId}/finalization`]: finalizationText,
                [`DBrdeliminar/${recordId}/status`]: status
            };
    
            update(ref(database), updates)
                .then(() => {
                    alert('Finalização salva com sucesso!');
                    loadRecords();
                })
                .catch((error) => {
                    console.error('Erro ao salvar finalização:', error);
                    alert('Ocorreu um erro ao salvar a finalização');
                });
        }
    
        // Mostra o modal de senha (mantido igual)
        function showPasswordModal(recordId) {
            const modal = document.getElementById('passwordModal');
            const adminPasswordInput = document.getElementById('adminPassword');
            const cancelBtn = document.getElementById('cancelDelete');
            const confirmBtn = document.getElementById('confirmDelete');
    
            adminPasswordInput.value = '';
            modal.style.display = 'flex';
    
            const closeModal = () => {
                modal.style.display = 'none';
            };
    
            cancelBtn.onclick = closeModal;
    
            confirmBtn.onclick = () => {
                const enteredPassword = adminPasswordInput.value;
                const adminPassword = "123Qwetr@#$%";
    
                if (enteredPassword === adminPassword) {
                    deleteRecord(recordId);
                    closeModal();
                } else {
                    alert('Senha de administrador incorreta!');
                }
            };
        }
    
        // Deleta um registro (mantido igual)
        function deleteRecord(recordId) {
            const recordRef = ref(database, `DBrdeliminar/${recordId}`);
            
            remove(recordRef)
                .then(() => {
                    console.log('Registro deletado com sucesso');
                    loadRecords();
                })
                .catch((error) => {
                    console.error('Erro ao deletar registro:', error);
                    alert('Ocorreu um erro ao deletar o registro');
                });
        }
    
        // Fetch and load records (mantido igual)
        function loadRecords() {
            const recordsRef = ref(database, 'DBrdeliminar/');
            const dateFilter = document.getElementById('dateFilter');
            const employeeFilter = document.getElementById('employeeFilter');
            const statusFilter = document.getElementById('statusFilter');
    
            const applyFilters = () => {
                onValue(recordsRef, (snapshot) => {
                    const data = snapshot.val();
                    console.log("Dados brutos do Firebase:", data); // Adicionado para debug
                    const filteredRecords = processRecords(
                        data, 
                        dateFilter.value, 
                        employeeFilter.value,
                        statusFilter.value
                    );
                    displayRecords(filteredRecords);
                }, {
                    onlyOnce: false
                });
            };
    
            applyFilters();
    
            dateFilter.addEventListener('change', applyFilters);
            employeeFilter.addEventListener('input', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
        }
    
        // Load records when page loads
        window.addEventListener('DOMContentLoaded', loadRecords);
    </script>
</body>
</html>